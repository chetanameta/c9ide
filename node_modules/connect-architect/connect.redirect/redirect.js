"use strict";

var url = require("url");

module.exports = function(options, imports, register) {
    
    var trustedDomainsRe = options.trustedDomainsRe || {};
    
    imports.connect.addResponseMethod("redirect", function(location) {
        this.writeHead(302, {Location: location});
        this.end("");
    });
    imports.connect.addResponseMethod("secureRedirect", function(location) {
        var parsedLocation = url.parse(location);
        
        if (!trustedDomainsRe.test(parsedLocation.host))
            location = parsedLocation.path;
            
        this.writeHead(302, {Location: location});
        this.end("");
    });
    imports.connect.addResponseMethod("returnTo", function(req, defaultReturn) {
        var url = defaultReturn || "/";
        if (req.session && req.session.returnTo) {
            url = req.session.returnTo;
            delete req.session.returnTo;
        }
        
        this.redirect(url);
    });
    imports.connect.addResponseMethod("moved", function(location) {
        this.writeHead(301, {Location: location});
        this.end("");
    });
    
    register(null, {
        "connect.redirect": {}
    });
};
